# emb-http-lua

*emb-http-lua* is a simple web server application capable of serving content generated by [LUA](https://www.lua.org/).
The core feature is its ability to embed application assets (HTML, Lua scripts, etc.) inside the executable, enabling the creation of single-file web servers with integrated logic.

# Usage

The software can be used in two modes:

1. **Standalone Web Server** <br> Serve assets directly from the filesystem.
	```
	./emb-http-lua -d DATA_PATH -p PORT
	```
	
2. **Embed Assets into Executable** <br> Create a self-contained executable with embedded assets.
	```
	./emb-http-lua -d DATA_PATH -o OUTPUT_EXECUTABLE
	```
	

# Assets schema

The asset directory (referred to as VFS) must contain the following files:

1. **/mime.types** <br>
A list mapping file extensions to MIME types. Each mapping is on a new line in the format: 
```Extension + white space/tab + mime_type```
		
```
htm    text/html
html   text/html
js     application/javascript
...
  ```
		
2. **/lib.lua** <br>
Lua library to load at startup.
		
3. **/main.lua** <br>
Main application file to load at startup.
		
4. **/other_file** <br>
Additional files to be served statically by the HTTP server.
		
# LUA Integration

Integration with Lua involves calling a specific Lua function:

```lua
function __httpHandle(request, response)
...
end 
```
    
The `request` argument is a table of the `HTTPRequest` metatable, containing fields:

| Field | Meaning |
| --- | --- |
| request.method | Request method (GET, POST, etc.) |
| request.path | Request path, e.g., `/some/path` |
| request.queryParams |  Query parameters as a table |
| request.headers | Headers as a table |

Refer to `luaapp_push_request` function for details.
<br>
		
The `__httpHandle` function processes the request and fills fields in the response argument (of type `HTTPResponse`):

| Field | Meaning |
| --- | --- |
| response.code | Status code for the response, e.g., 200 |
| response.headers | Response headers as a table |
| response.content | Response content |
		
Refer to `luaapp_pop_response` function for details.
		
# Embedding Assets

To embed assets in the executable, the application creates a copy of itself (copy of `/proc/self/exe`) and adds another program header (segment) to the ELF contents.
<br><br>
This segment is aligned and placed in the process's virtual memory at:
```
#define VFS_EMBED_BASE_ADDR 0x80000000
```
	
# Compiling

The main compilation mode for this application is static linkage, creating a self-contained web application.
<br>
Note that this has been tested only on **amd64** architecture. Changes to ELF and its segments may affect behavior on other architectures.
<br>
To compile:

1. Compile the Lua runtime:
```bash
wget http://www.lua.org/ftp/lua-5.4.4.tar.gz
tar zxvf lua-5.4.4.tar.gz
cd lua-5.4.4
make
```

2. Update the Makefile to point to the correct Lua library and include and `libm.a`:
```makefile
...
INCLUDES=-I/path/to/lua-5.4.4/src
OBJS=/path/to/lua-5.4.4/src/liblua.a /usr/lib/libm.a
...
```

3. Run `make` to build the application.

# Dependencies

This project uses:
1. **HTTPServer** from https://github.com/jeremycw/httpserver.h
2. **HashMap** implementation from https://github.com/tidwall/hashmap.c
		

# Licence

MIT Licence
